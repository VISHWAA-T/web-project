<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Management</title>
    <link rel="stylesheet" href="user-styles.css" />
</head>
<body>
    <nav>
        <a href="dashboard.html">Dashboard</a>
        <button id="logoutBtn">Logout</button>
    </nav>

    <div class="container">
        <h2>User Management</h2>
        <form id="userForm">
            <input type="hidden" id="userId" />
            <input type="text" id="username" placeholder="Username" required />
            <input type="password" id="password" placeholder="Password" required />
            <select id="role">
                <option value="CUSTOMER">Customer</option>
                <option value="ADMIN">Admin</option>
            </select>
            <button type="submit">Save User</button>
            <button type="button" id="clearBtn">Clear</button>
        </form>

        <h3>All Users</h3>
        <table border="1" id="usersTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="message"></p>
    </div>

    <script>
        const userForm = document.getElementById('userForm');
        const usersTableBody = document.querySelector('#usersTable tbody');
        const message = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');
        const clearBtn = document.getElementById('clearBtn');

        const API_BASE = 'http://localhost:8080';

        logoutBtn.onclick = () => {
            localStorage.clear();
            window.location.href = 'index.html';
        };

        clearBtn.onclick = () => {
            userForm.reset();
            document.getElementById('userId').value = '';
            message.textContent = '';
        };

        // Load users
        async function loadUsers() {
            const res = await fetch(`${API_BASE}/users`);
            const users = await res.json();
            usersTableBody.innerHTML = '';
            users.forEach(u => {
                usersTableBody.innerHTML += `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.role}</td>
                        <td>
                            <button onclick="editUser(${u.id}, '${u.username}', '${u.role}')">Edit</button>
                            <button onclick="deleteUser(${u.id})">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        function editUser(id, username, role) {
            document.getElementById('userId').value = id;
            document.getElementById('username').value = username;
            document.getElementById('password').value = '';
            document.getElementById('role').value = role;
            message.textContent = '';
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            await fetch(`${API_BASE}/users/${id}`, { method: 'DELETE' });
            message.textContent = 'User deleted.';
            loadUsers();
        }

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const role = document.getElementById('role').value;

            let userPayload = { username, password, role };

            if (id) {
                // Update
                await fetch(`${API_BASE}/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userPayload),
                });
                message.textContent = 'User updated.';
            } else {
                // Create
                await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userPayload),
                });
                message.textContent = 'User created.';
            }
            userForm.reset();
            document.getElementById('userId').value = '';
            loadUsers();
        });

        // Initial load
        loadUsers();
    </script>
</body>
</html>
